{% load static %}

<!DOCTYPE html>
<html>
<head>
	<title>Barcode</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-0evHe/X+R7YkIZDRvuzKMRqM+OrBnVFBL6DOitfPri4tjfHxaWutUpFmBp4vmVor" crossorigin="anonymous">

    <link rel="stylesheet" type="text/css" href="{% static '/css/main.css' %}"
</head>
<body>
    {% include 'navbar.html' %}

    <h1 class="text-center text-uppercase fs-2 fw-semibold">Barcode</h1>

    {% include 'info.html' %}
    
    {%  include 'barcodeTable.html' %}

    <button class="btn btn-success" id="generateBtn">Generate PDF</button>

    <hr>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js" integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0-beta1/dist/js/bootstrap.min.js" integrity="sha384-kjU+l4N0Yf4ZOJErLsIcvOU2qSb74wXpOhqTvwVx3OElZRweTnQ6d31fXEoRD1Jy" crossorigin="anonymous"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <script type="text/javascript" src="https://html2canvas.hertzen.com/dist/html2canvas.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <script>
        const table=document.getElementById("table");
        let input = document.getElementsByClassName('barcodeInput')[document.getElementsByClassName('barcodeInput').length - 1]

        const onChanegFunction = async () => {
            if(input.value.length){
                let barcodeInfo = {}
                await fetch('http://127.0.0.1:8000/get/'+input.value)
                .then(res => res.json())
                .then(data => barcodeInfo = data)
                .catch(err => console.log(err))

                if(barcodeInfo.message === 'success') {
                    const currentRow = table.children[table.children.length - 1].children
                    currentRow[1].innerHTML = barcodeInfo.barcodenumber
                    currentRow[2].innerHTML = barcodeInfo.product_name
                    currentRow[3].innerHTML = barcodeInfo.item_number
                    currentRow[4].innerHTML = barcodeInfo.item_number
                    currentRow[5].innerHTML = '1'

                    const newRow = table.insertRow()
                    newRow.classList.add("d-flex")
                    newRow.innerHTML = '<th class="col-1" scope="row">' + table.children.length + '</th><td class="col-2"><input type="text" class="barcodeInput" /></td><td class="col-6"></td><td class="col-1"></td><td class="col-1"></td><td class="col-1"></td>'
                    input = document.getElementsByClassName('barcodeInput')[document.getElementsByClassName('barcodeInput').length - 1]
                    input.onchange = onChanegFunction
                } else {
                    alert('Enter Valid Barcode')
                }
            } 
        }
        
        input.addEventListener('change',onChanegFunction)
    
        const issueNo = document.getElementById('issueNo')
        const generateBtn = document.getElementById('generateBtn')

        function CreatePDFfromHTML() {
            if(issueNo.value !== 'None') {
                var HTML_Width = $("body").height() * 0.707;
                var HTML_Height = $("body").height() / 2;
                var top_left_margin = 0;
                var PDF_Width = HTML_Width + (top_left_margin * 2);
                var PDF_Height = (PDF_Width * 1.5) + (top_left_margin * 2);
                var canvas_image_width = HTML_Width;
                var canvas_image_height = HTML_Height;

                var totalPDFPages = Math.ceil(HTML_Height / PDF_Height) - 1;

                html2canvas($("body")[0]).then(function (canvas) {
                    var imgData = canvas.toDataURL("image/jpeg", 1.0);
                    var pdf = new jsPDF('p', 'pt', [PDF_Width, PDF_Height]);
                    pdf.addImage(imgData, 'JPG', top_left_margin, top_left_margin, canvas_image_width, canvas_image_height);
                    for (var i = 1; i <= totalPDFPages; i++) { 
                        pdf.addPage(PDF_Width, PDF_Height);
                        pdf.addImage(imgData, 'JPG', top_left_margin, -(PDF_Height*i)+(top_left_margin*4),canvas_image_width,canvas_image_height);
                    }
                    pdf.save("session"+ issueNo.value +".pdf");
                    // $("body").hide();
                });
            } else {
                alert('Create a Session')
            }
        }

        generateBtn.addEventListener('click', CreatePDFfromHTML)
    </script>

</body>
</html>